(function(videojs){
"use strict";function _typeof(o){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o},_typeof(o)}function _callSuper(t,o,e){return o=_getPrototypeOf(o),_possibleConstructorReturn(t,_isNativeReflectConstruct()?Reflect.construct(o,e||[],_getPrototypeOf(t).constructor):o.apply(t,e))}function _possibleConstructorReturn(t,e){if(e&&("object"==_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(_isNativeReflectConstruct=function _isNativeReflectConstruct(){return!!t})()}function _getPrototypeOf(t){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},_getPrototypeOf(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},_setPrototypeOf(t,e)}function _classCallCheck(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,_toPropertyKey(o.key),o)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toPropertyKey(t){var i=_toPrimitive(t,"string");return"symbol"==_typeof(i)?i:i+""}function _toPrimitive(t,r){if("object"!=_typeof(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=_typeof(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}var DotmetricsVideoPlugin=function(){function DotmetricsVideoPlugin(organizationId,siteId,playerType,playerVersion,pluginConfigDoneCallback){_classCallCheck(this,DotmetricsVideoPlugin);this._organizationId=organizationId;this._siteId=siteId;this._error=null;this._playerType=playerType;this._playerVersion=playerVersion;this._config=null;this._videos=[];this._currentVideo=null;this._dotmetricsPageData=null;this._pluginConfigDoneCallback=pluginConfigDoneCallback;this._videoErrorSent=false;this._init();this._pageUrl=this._getPageUrl();this._panelHitGifDone=false;this._usingDMExtension=false}return _createClass(DotmetricsVideoPlugin,[{key:"_init",value:function _init(){this._loadConfig()}},{key:"_getPageUrl",value:function _getPageUrl(){var url;if(window.self!==window.top){try{url=window.top.location.href}catch(e){url=window.document.referrer}}else{url=window.location.href}return url}},{key:"_getPageDomain",value:function _getPageDomain(){var domain;try{domain=window.top.location.hostname}catch(e){domain=window.location.hostname}return domain}},{key:"addNewVideo",value:function addNewVideo(url,width,height,duration){var title=arguments.length>4&&arguments[4]!==undefined?arguments[4]:"";var options=arguments.length>5&&arguments[5]!==undefined?arguments[5]:null;var existingVideo=this._videos.find(function(item){return item.videoURL==url&&item.title==title});if(existingVideo){this._currentVideo=existingVideo}else{var orgId=this._organizationId;var siteId=this._siteId;if(options!=null){if(options.organizationId){orgId=options.organizationId}if(options.siteId){siteId=options.siteId}}this._currentVideo={videoURL:url,title:title,width:parseInt(width),height:parseInt(height),duration:isNaN(duration)||duration==null?0:duration,timeWatched:0,isLiveStream:false,events:[],hasNewData:false,organizationId:orgId,siteId:siteId};this._videos.push(this._currentVideo)}this._sendVideoData();return this._currentVideo}},{key:"setIsLiveStream",value:function setIsLiveStream(){if(this._currentVideo==null){return}this._currentVideo.isLiveStream=true}},{key:"addToTimeWatched",value:function addToTimeWatched(time){this._currentVideo.timeWatched+=time;this._currentVideo.hasNewData=true;this._dispatchVideoPluginUpdate()}},{key:"addEvent",value:function addEvent(eventName,data){if(this._currentVideo==null){return}var event=Object.assign({},data);event.eventName=eventName;event.timestamp=new Date;this._currentVideo.events.push(event);this._currentVideo.hasNewData=true;this._dispatchVideoPluginUpdate()}},{key:"_loadConfig",value:function _loadConfig(){var _this=this;var siteIdParam=this._siteId!=null?"&siteId=".concat(this._siteId):"";fetch("https://uk-script.dotmetrics.net/VideoPluginConfig.dotmetrics?organizationId=".concat(this._organizationId).concat(siteIdParam)).then(function(response){return response.json()}).then(function(data){_this._config=data;if(_this._config.DataCollectionActive==true){_this._collectDotmetricsData();_this._initEventListeners()}_this._pluginConfigDoneCallback(_this._config.DataCollectionActive);_this._dispatchVideoPluginUpdate()})["catch"](function(e){_this._pluginConfigDoneCallback(false)})}},{key:"_collectDotmetricsData",value:function _collectDotmetricsData(){var _this2=this;var dotmetricsCheckCounter=0;var intervalId=setInterval(function(){_this2._checkForDotmetrics();dotmetricsCheckCounter++;if(dotmetricsCheckCounter>=DotmetricsVideoPlugin.DOTMETRICS_PING_LIMIT){clearInterval(intervalId);setTimeout(function(){_this2._callPanelHitGif()},DotmetricsVideoPlugin.DOTMETRICS_PING_INTERVAL)}},DotmetricsVideoPlugin.DOTMETRICS_PING_INTERVAL);this._checkForDotmetrics();window.addEventListener("message",function(event){var message=event.data;if(message.data&&message.type==DotmetricsVideoPlugin.DOTMETRICS_RECEIVE_PAGE_DATA_MESSAGE_TYPE){clearInterval(intervalId);_this2._dotmetricsPageData=message.data;_this2._callPanelHitGif();_this2._dispatchVideoPluginUpdate()}})}},{key:"_checkForDotmetrics",value:function _checkForDotmetrics(){try{window.top.postMessage({type:DotmetricsVideoPlugin.DOTMETRICS_REQUEST_PAGE_DATA_MESSAGE_TYPE,source:"dotmetrics-extension"},"*")}catch(e){}}},{key:"_callPanelHitGif",value:function _callPanelHitGif(){if(this._config.RMScriptEndpoint==null||this._config.RMScriptEndpoint==""||this._panelHitGifDone){return}this._panelHitGifDone=true;var rand=new Date().getTime();var pvs=window.top.location==window.self.location?1:2;var tzOffset=new Date().getTimezoneOffset();var ecid="";var id="";if(this._dotmetricsPageData!=null){ecid=this._dotmetricsPageData.ecid;id=this._dotmetricsPageData.SiteSectionId}var params="?id=".concat(id,"&url=").concat(this._pageUrl,"&dom=").concat(this._getPageDomain(),"&r=").concat(rand,"&pvs=").concat(pvs,"&pvid=").concat(ecid,"&tzOffset=").concat(tzOffset,"&vpid=").concat(this._config.PlayerInstanceId);var panelImgUrl=this._config.RMScriptEndpoint+params;var panelIm=new Image;panelIm.src=panelImgUrl}},{key:"_initEventListeners",value:function _initEventListeners(){var _this3=this;window.addEventListener("message",function(event){if(event.data.type=="DotmetricsExtensionAvailableInTopWindow"){_this3._usingDMExtension=true}});document.addEventListener("visibilitychange",function(){if(document.visibilityState==="hidden"){_this3._sendVideoData()}})}},{key:"_sendVideoData",value:function _sendVideoData(){if(this._config==null||this._videos.length==0){return}if(typeof this._videos.find(function(item){return item.hasNewData==true})=="undefined"){return}var data=this._getDataToSend();var dataEncoded=encodeURIComponent(btoa(JSON.stringify(data)));var time=new Date().getTime();var dataToSend="v=".concat(dataEncoded,"&r=").concat(time);var headers={type:"application/x-www-form-urlencoded"};var blob=new Blob([dataToSend],headers);if(navigator.sendBeacon){this._sendMessageToExtension(data,"video-plugin-beacon");var url="".concat(this._config.VideoEndpoint,"?vpid=").concat(this._config.PlayerInstanceId);navigator.sendBeacon(url,blob)}}},{key:"sendVideoError",value:function sendVideoError(error){if(this._videoErrorSent==true){return}this._videoErrorSent=true;var siteSectionId=this._dotmetricsPageData!=null?this._dotmetricsPageData.SiteSectionId:null;var data={type:"videoPlugin",ecid:this._dotmetricsPageData!=null?this._dotmetricsPageData.EventChainId:"",details:{player:this._playerType,playerVersion:this._playerVersion},name:error&&error.name?error.name:"",message:error&&error.message?error.message:"",stack:error&&error.stack?error.stack:"",sectionId:siteSectionId,pageUrl:this._pageUrl};var dataEncoded=encodeURIComponent(btoa(JSON.stringify(data)));var time=new Date().getTime();var dataToSend="v=".concat(dataEncoded,"&r=").concat(time);fetch(this._config.ErrorEndpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:dataToSend}).then(function(response){})["catch"](function(e){})}},{key:"_getDataToSend",value:function _getDataToSend(){var data={playerName:this._playerType,playerVersion:this._playerVersion,playerInstanceId:this._config.PlayerInstanceId,TimeZoneOffset:new Date().getTimezoneOffset(),pageUrl:this._pageUrl,videos:[]};this._videos.forEach(function(video){if(video.hasNewData==true){var videoItem=Object.assign({},video);videoItem.duration=Math.round(video.duration);videoItem.timeWatched=Math.round(video.timeWatched);videoItem.title=encodeURIComponent(videoItem.title);delete videoItem.hasNewData;data.videos.push(videoItem);video.hasNewData=false}});if(this._dotmetricsPageData){data.enterPageData=this._dotmetricsPageData}return data}},{key:"_dispatchVideoPluginUpdate",value:function _dispatchVideoPluginUpdate(){if(this._config==null){return}if(this._usingDMExtension==true){var data={organizationId:this._organizationId,siteId:this._siteId,error:this._config.ValidationMessage,playerName:this._playerType,playerVersion:this._playerVersion,playerInstanceId:this._config.PlayerInstanceId,TimeZoneOffset:new Date().getTimezoneOffset(),enterPageData:this._dotmetricsPageData,dataCollectionActive:this._config.DataCollectionActive,videos:[]};this._videos.forEach(function(video){var vData=Object.assign({},video);vData.duration=Math.round(vData.duration);vData.timeWatched=Math.round(vData.timeWatched);data.videos.push(vData)});this._sendMessageToExtension(data,"video-plugin-update")}}},{key:"_sendMessageToExtension",value:function _sendMessageToExtension(data,type){if(this._usingDMExtension==true){var message={target:"dotmetrics-extension",type:type,data:data};try{window.top.postMessage(message,"*")}catch(e){}}}}])}();_defineProperty(DotmetricsVideoPlugin,"DOTMETRICS_PING_INTERVAL",1000);_defineProperty(DotmetricsVideoPlugin,"DOTMETRICS_PING_LIMIT",10);_defineProperty(DotmetricsVideoPlugin,"DOTMETRICS_REQUEST_PAGE_DATA_MESSAGE_TYPE","getEnterPageData");_defineProperty(DotmetricsVideoPlugin,"DOTMETRICS_RECEIVE_PAGE_DATA_MESSAGE_TYPE","enterPageData");var Plugin=videojs.getPlugin("plugin");var VideojsDotmetricsPlugin=function(_Plugin){function VideojsDotmetricsPlugin(player,options){var _this4;_classCallCheck(this,VideojsDotmetricsPlugin);_this4=_callSuper(this,VideojsDotmetricsPlugin,[player,options]);_this4.organizationId=options&&options.organizationId?options.organizationId:null;_this4.siteId=options&&options.siteId?options.siteId:null;_this4.player=player;_this4.lastPlayheadPosition=null;_this4.lastPlayheadPositionBeforeSeek=null;_this4.lastTimestamp=null;_this4.playerIsInPIPMode=false;_this4.eventListeners=[];_this4.intersectionObserver={observerInstance:null,target:null};var playerType="videojs";var playerVersion=window.videojs.VERSION;_this4.dmPlugin=new DotmetricsVideoPlugin(_this4.organizationId,_this4.siteId,playerType,playerVersion,function(dataCollectionActive){if(dataCollectionActive!=true){_this4.stopDataCollection()}});_this4.initEventListeners();return _this4}_inherits(VideojsDotmetricsPlugin,_Plugin);return _createClass(VideojsDotmetricsPlugin,[{key:"stopDataCollection",value:function stopDataCollection(){var _this5=this;this.intersectionObserver.observerInstance.unobserve(this.intersectionObserver.target);this.eventListeners.forEach(function(listener){_this5.player.off(listener.type,listener.handler)})}},{key:"initEventListeners",value:function initEventListeners(){var _this6=this;var isCurrentlyMuted=false;this.initIntersectionEvents();this.eventListeners.push({type:"loadedmetadata",handler:function handler(e){try{_this6.addNewVideoSource();if(_this6.player.autoplay()){_this6.dmPlugin.addEvent("autoplay",{})}isCurrentlyMuted=_this6.player.muted()||_this6.player.volume()==0;_this6.dmPlugin.addEvent("mute",{currentTime:_this6.player.currentTime(),additionalData:{muted:isCurrentlyMuted}});_this6.sendManualIntersectionEvent()}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"timeupdate",handler:function handler(){try{if(_this6.lastPlayheadPosition&&_this6.player.seeking()==false&&_this6.player.scrubbing()==false){var timeDelta=(new Date().getTime()-_this6.lastTimestamp)*.001;try{if(_this6.player.liveTracker!="undefined"&&_this6.player.liveTracker.isLive&&_this6.player.liveTracker.isLive()){_this6.dmPlugin.setIsLiveStream()}}catch(e){}if(_this6.player.currentTime()!=_this6.lastPlayheadPosition&&timeDelta>0&&timeDelta<1){_this6.dmPlugin.addToTimeWatched(timeDelta)}}_this6.lastPlayheadPosition=_this6.player.currentTime();_this6.lastTimestamp=Date.now();if(_this6.player.seeking()==false&&_this6.player.scrubbing()==false){_this6.lastPlayheadPositionBeforeSeek=_this6.player.currentTime()}}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"ended",handler:function handler(e){try{_this6.dmPlugin.addEvent("ended",{})}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"enterpictureinpicture",handler:function handler(e){try{_this6.sendResizeEvent(_this6.player.currentTime(),e.pictureInPictureWindow.width,e.pictureInPictureWindow.height);_this6.sendIntersectionEvent(true);_this6.playerIsInPIPMode=true}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"leavepictureinpicture",handler:function handler(e){try{_this6.playerIsInPIPMode=false;_this6.sendResizeEvent(_this6.player.currentTime(),_this6.player.currentWidth(),_this6.player.currentHeight());_this6.sendManualIntersectionEvent()}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"error",handler:function handler(e){try{_this6.dmPlugin.addEvent("error",{currentTime:_this6.player.currentTime()})}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"fullscreenchange",handler:function handler(){try{_this6.dmPlugin.addEvent("fullscreenchange",{currentTime:_this6.player.currentTime(),additionalData:{isFullScreen:_this6.player.isFullscreen()}})}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"pause",handler:function handler(e){try{if(_this6.player.seeking()){return}_this6.dmPlugin.addEvent("pause",{currentTime:_this6.player.currentTime()})}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"play",handler:function handler(e){try{if(_this6.player.seeking()){return}_this6.dmPlugin.addEvent("play",{currentTime:_this6.player.currentTime()})}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"playerresize",handler:function handler(e){try{_this6.sendResizeEvent(_this6.player.currentTime(),_this6.player.currentWidth(),_this6.player.currentHeight())}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"ratechange",handler:function handler(e){try{_this6.dmPlugin.addEvent("ratechange",{currentTime:_this6.player.currentTime(),additionalData:{playbackRate:_this6.player.playbackRate()}})}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"seeking",handler:function handler(e){try{_this6.dmPlugin.addEvent("seeking",{currentTime:_this6.lastPlayheadPositionBeforeSeek})}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"seeked",handler:function handler(e){try{_this6.dmPlugin.addEvent("seeked",{currentTime:_this6.player.currentTime()})}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.push({type:"volumechange",handler:function handler(e){try{var muted=_this6.player.muted()||_this6.player.volume()==0;if(muted==isCurrentlyMuted){return}isCurrentlyMuted=muted;_this6.dmPlugin.addEvent("mute",{currentTime:_this6.player.currentTime(),additionalData:{muted:muted}})}catch(error){_this6.handleDataCollectionError(error)}}});this.eventListeners.forEach(function(listener){_this6.player.on(listener.type,listener.handler)})}},{key:"sendResizeEvent",value:function sendResizeEvent(currentTime,width,height){this.dmPlugin.addEvent("resize",{currentTime:currentTime,additionalData:{width:width,height:height}})}},{key:"addNewVideoSource",value:function addNewVideoSource(){var videoUrl=this.player.currentSrc();var title=this.player.mediainfo?this.player.mediainfo.name:"";if(videoUrl==""){return}if(!(this.dmPlugin._currentVideo&&this.dmPlugin._currentVideo.videoURL==videoUrl&&this.dmPlugin._currentVideo.title==title)){var duration=Math.max(0,this.player.duration());this.dmPlugin.addNewVideo(videoUrl,this.player.videoWidth(),this.player.videoHeight(),duration,title);this.lastPlayheadPosition=null;this.lastTimestamp=null}}},{key:"initIntersectionEvents",value:function initIntersectionEvents(){var _this7=this;try{var observer=new IntersectionObserver(function(e){_this7.sendIntersectionEvent(e[0].isIntersecting)},{root:null,rootMargin:"0px",threshold:.5});observer.observe(this.player.el());this.intersectionObserver={observerInstance:observer,target:this.player.el()}}catch(error){this.handleDataCollectionError(error)}}},{key:"sendManualIntersectionEvent",value:function sendManualIntersectionEvent(){try{var rect=this.player.el().getBoundingClientRect();var isVisible=rect.top>=-rect.height*.5&&rect.left>=-rect.width*.5&&rect.bottom<=(window.innerHeight||document.documentElement.clientHeight)+rect.height*.5&&rect.right<=(window.innerWidth||document.documentElement.clientWidth)+rect.width*.5;this.sendIntersectionEvent(isVisible)}catch(error){this.handleDataCollectionError(error)}}},{key:"sendIntersectionEvent",value:function sendIntersectionEvent(isVisible){try{if(this.playerIsInPIPMode){return}this.dmPlugin.addEvent("viewable",{currentTime:this.player.currentTime(),additionalData:{viewable:isVisible}})}catch(error){this.handleDataCollectionError(error)}}},{key:"handleDataCollectionError",value:function handleDataCollectionError(error){this.stopDataCollection();this.dmPlugin.sendVideoError(error)}}])}(Plugin);videojs.registerPlugin("dotmetricsVideoJSPlugin",VideojsDotmetricsPlugin);

})(videojs);